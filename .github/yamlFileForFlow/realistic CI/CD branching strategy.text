dev =>Auto
When code is pushed â†’ auto deploy to Staging
--------------------------------------
staging
Manual

You click a button â†’ deploy to Production (main)

--------------------------------------------
main
Manual or release
Production deployment only when you explicitly run it


name: FastAPI Multi-Stage CI/CD

on:
  push:
    branches:
      - "dev"
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to deploy"
        required: true
        default: "staging"
        type: choice
        options:
          - "staging"
          - "production"

jobs:
  # ---------------------------
  # ğŸ§ª Test job for all branches
  # ---------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run tests
        run: |
          echo "Running tests..."
          pytest || echo "âš ï¸ No tests found, skipping."

  # ------------------------------------------------
  # ğŸš€ Auto deploy job for Dev â†’ Staging environment
  # ------------------------------------------------
  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging
        run: |
          echo "ğŸš€ Automatically deploying DEV â†’ STAGING environment"
          # Example placeholder for real deployment (Render, EC2, etc.)
          echo "âœ… Staging deployment complete."

  # ---------------------------------------------------
  # ğŸš€ Manual deploy job for Staging â†’ Production (Main)
  # ---------------------------------------------------
  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "ğŸš€ Manual deployment triggered from STAGING â†’ PRODUCTION"
          echo "âœ… Production deployment complete."
